import{s as re,_ as ce}from"./formCustomisation-2c9d6b04.js";import{r as B,h as t,a0 as ue,e as d,k as R,t as P,D as W,a1 as O,f as g,v as K,d as z,m as X,n as de,A as h,W as N,Q as D,a2 as me,a3 as ee,w as v,l as $,s as Y,g as r,y as V,H as te,c as q,a4 as pe,q as fe,u as ke,V as ve,O as ge,I as ye,M as _e,a5 as Z,X as be,N as xe,Y as we,Z as he,x as $e,$ as Te}from"./index-62a62e6e.js";import{_ as Ve}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-c8f73628.js";import{_ as Ae}from"./Dropdown.vue_vue_type_script_setup_true_lang-8f31c9b1.js";import{g as Ce,b as je,T as Se,A as Ie,C as Me,_ as Ue,a as Re,c as Be,d as De,e as Ee,f as Fe}from"./TicketAgentFields-2425efde.js";import{T as qe,u as He,s as U}from"./more-horizontal-44c34a82.js";import"./dayjs-23c9994e.js";import{L as Le}from"./knowledgeBase-e21cae7f.js";import{_ as Oe}from"./FadedScrollableDiv.vue_vue_type_script_setup_true_lang-009f88f9.js";import{a as Ne,_ as Pe}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-f4b785e0.js";import{u as ze,I as G}from"./ticketStatus-e3b3db3a.js";import{g as Je}from"./globalStore-353b4b5d.js";import{_ as Qe}from"./Dropdown-f5693848.js";import{L as ae}from"./merge-36299d39.js";import{_ as We}from"./Link-2b0a1c2c.js";import"./AttachmentItem.vue_vue_type_script_setup_true_lang-cb2930a7.js";import"./FileUploader-08f99e92.js";import"./TextEditor.vue_vue_type_script_setup_true_lang-3540b034.js";import"./UserAvatar.vue_vue_type_script_setup_true_lang-3c21d3f7.js";import"./Avatar.vue_vue_type_script_setup_true_lang-d4d1e36b.js";import"./Autocomplete-b8bbe20a.js";import"./EmailContent-07157247.js";import"./StarRating.vue_vue_type_script_setup_true_lang-af2bc1e1.js";const Xe={__name:"Icon",props:{icon:{type:[String,Object],required:!0}},setup(p){return(w,y)=>{const _=B("FeatherIcon");return t(ue)(p.icon)?(d(),R("div",W(O({key:0},w.$attrs)),P(p.icon),17)):typeof p.icon=="string"?(d(),g(_,O({key:1,name:p.icon},w.$attrs),null,16,["name"])):(d(),g(K(p.icon),W(O({key:2},w.$attrs)),null,16))}}},Ye={class:"flex flex-col gap-4"},Ze={class:"text-p-base text-ink-gray-8"},Ge={class:"whitespace-nowrap font-semibold"},Ke={class:"flex items-center gap-2 rounded-md p-2 ring-1 ring-gray-200"},et=z({__name:"TicketMergeModal",props:X({ticket:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:X(["update"],["update:modelValue"]),setup(p,{emit:w}){const y=p,_=w,A=de(p,"modelValue");function C(){const u={status:["in",["Open","Replied"]],is_merged:0,name:["!=",y.ticket.name]};return y.ticket.customer&&(u.customer=y.ticket.customer),y.ticket.raised_by&&(u.raised_by=["like",`%${y.ticket.raised_by}%`]),u}const m=h(null),l=h(null),c=N({url:"helpdesk.helpdesk.doctype.hd_ticket.api.merge_ticket",makeParams({source:u,target:n}){return{source:u,target:n}},validate({source:u,target:n}){if(!u)throw{message:"Category is required"};if(!n)throw{message:"Ticket to merged with is required"}},onSuccess:()=>{D.success("Ticket merged successfully"),_("update"),A.value=!1,window.open(window.location.origin+"/helpdesk/tickets/"+m.value,"_blank"),m.value=null}}),I=me({doctype:"HD Ticket",filters:{name:["=",m]},fields:["subject"],onSuccess:u=>{u.length>0&&(l.value=u[0].subject)}});ee(()=>m.value,u=>{u&&(I.update({filters:{name:["=",u]}}),I.reload())});function j(){c.submit({source:y.ticket.name,target:m.value})}return(u,n)=>{const s=We,H=B("FormControl"),L=B("Button");return d(),g(t(te),{options:{title:"Merge with another ticket"},modelValue:A.value,"onUpdate:modelValue":n[2]||(n[2]=M=>A.value=M)},{"body-content":v(()=>[$("div",Ye,[$("p",Ze,[n[3]||(n[3]=Y(" All comments and emails of the ticket ",-1)),$("span",Ge,"#"+P(u.ticket.name),1),n[4]||(n[4]=Y(" will be moved to the selected ticket. ",-1))]),r(s,{class:"form-control",doctype:"HD Ticket",placeholder:"Select Ticket",filters:C(),label:"Ticket","page-length":10,value:m.value,"show-description":!0,onChange:n[0]||(n[0]=M=>m.value=String(M))},null,8,["filters","value"]),m.value?(d(),g(H,{key:0,label:"Ticket Subject",type:"text",modelValue:l.value,"onUpdate:modelValue":n[1]||(n[1]=M=>l.value=M),disabled:!0},null,8,["modelValue"])):V("",!0),$("div",Ke,[r(t(qe),{class:"h-6 w-5 w-min-5 w-max-5 min-h-5 max-w-5 text-yellow-500"}),n[5]||(n[5]=$("div",{class:"text-wrap text-sm text-gray-700"}," This action is irreversible. ",-1))])])]),actions:v(()=>[r(L,{class:"w-full",variant:"solid",label:m.value?`Merge with ticket #${m.value} `:"Select Ticket",loading:t(c).loading,"icon-left":m.value&&t(ae),onClick:j},null,8,["label","loading","icon-left"])]),_:1},8,["modelValue"])}}}),tt={class:"flex !w-[382px] flex-col justify-between border-l"},at={class:"flex h-10.5 items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9 justify-between"},st=z({__name:"TicketAgentSidebar",props:{ticket:{}},emits:["update","email:open","reload"],setup(p,{emit:w}){const y=p,_=w;function A(l=null){var c;l.value&&typeof l.value=="object"&&(l.value=((c=l.value.target)==null?void 0:c.value)||null),_("update",l)}const C=h(!1),m=q(()=>!y.ticket.is_merged&&["Open","Replied"].includes(y.ticket.status));return(l,c)=>{const I=B("Button"),j=Qe,u=Ne;return d(),R("div",tt,[$("div",at,[$("span",{class:"cursor-copy text-lg font-semibold",onClick:c[0]||(c[0]=n=>t(pe)(l.ticket.name,`'${l.ticket.name}' copied to clipboard`))},"#"+P(l.ticket.name),1),m.value?(d(),g(j,{key:0,options:[{label:"Merge Ticket",onClick:()=>C.value=!0,icon:t(ae),condition:()=>!l.ticket.is_merged}]},{default:v(()=>[r(I,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:1},8,["options"])):V("",!0)]),r(Ce,{contact:l.ticket.contact,"onEmail:open":c[1]||(c[1]=n=>_("email:open",n))},null,8,["contact"]),l.ticket.feedback_rating?(d(),g(u,{key:0,class:"py-3 !px-6 !gap-3 text-base text-gray-600",ticket:l.ticket},null,8,["ticket"])):V("",!0),r(je,{ticket:l.ticket},null,8,["ticket"]),r(Se,{ticket:l.ticket,onUpdate:A},null,8,["ticket"]),C.value?(d(),g(et,{key:1,ticket:l.ticket,modelValue:C.value,"onUpdate:modelValue":c[2]||(c[2]=n=>C.value=n),onUpdate:c[3]||(c[3]=n=>_("reload"))},null,8,["ticket","modelValue"])):V("",!0)])}}}),ot={class:"flex flex-col"},nt={key:1},it={key:1,class:"flex h-full overflow-hidden"},lt={class:"flex flex-1 flex-col max-w-[calc(100%-382px)]"},rt={class:"overflow-y-hidden flex flex-1 !h-full flex-col"},ct={class:"flex flex-col flex-1 gap-3"},Ut=z({__name:"TicketAgent",props:{ticketId:{type:String,required:!0}},setup(p){const w=fe(),y=ke(),_=ze(),{getUser:A}=ve(),{$dialog:C}=Je(),m=h(null),l=h(null),c=h(""),I=h(!1),j=p;ee(()=>j.ticketId,()=>{s.reload()});const{findView:u}=He("HD Ticket");he("communicationArea",l);const n=h(!1),s=N({url:"helpdesk.helpdesk.doctype.hd_ticket.api.get_one",auto:!0,makeParams:()=>({name:j.ticketId}),transform:o=>{o._assign&&(o.assignees=JSON.parse(o._assign).map(e=>({name:e,image:A(e).user_image,label:A(e).full_name}))),c.value=o.subject},onSuccess:o=>{document.title=o.subject,re(s,{doc:o,call:we,router:y,toast:D,$dialog:C,updateField:H,createToast:D.create})}});function H(o,e,f=()=>{}){F(o,e),f()}const L=q(()=>{var e,f,b,T;let o=[{label:"Tickets",route:{name:"TicketsAgent"}}];if(w.query.view){const k=u(w.query.view);k&&o.push({label:(e=k.value)==null?void 0:e.label,icon:ge((f=k.value)==null?void 0:f.icon),route:{name:"TicketsAgent",query:{view:(b=k.value)==null?void 0:b.name}}})}return o.push({label:(T=s.data)==null?void 0:T.subject,onClick:()=>{n.value=!0}}),o}),M=()=>{var o;c.value!==((o=s.data)==null?void 0:o.subject)&&(F("subject",c.value),n.value=!1)},se=q(()=>_.options.map(o=>({label:o,value:o,onClick:()=>F("status",o),icon:()=>ye(G,{class:_.textColorMap[o]})}))),J=h(0),oe=[{name:"activity",label:"Activity",icon:Ie},{name:"email",label:"Emails",icon:Pe},{name:"comment",label:"Comments",icon:Me}],Q=q(()=>{const o=s.data.communications.map((a,x)=>({subject:a.subject,content:a.content,sender:{name:a.user.email,full_name:a.user.name},to:a.recipients,type:"email",key:a.creation,cc:a.cc,bcc:a.bcc,creation:a.communication_date||a.creation,attachments:a.attachments,name:a.name,deliveryStatus:a.delivery_status,isFirstEmail:x===0})),e=s.data.comments.map(a=>({name:a.name,type:"comment",key:a.creation,commentedBy:a.commented_by,commenter:a.user.name,creation:a.creation,content:a.content,attachments:a.attachments})),f=[...s.data.history,...s.data.views].map(a=>({type:"history",key:a.creation,content:a.action?a.action:"viewed this",creation:a.creation,user:a.user.name+" "})),b=[...o,...e,...f].sort((a,x)=>new Date(a.creation)-new Date(x.creation)),T=[];let k=0;for(;k<b.length;){const a=b[k];if(a.type==="history"){a.relatedActivities=[a];for(let x=k+1;x<b.length+1;x++){const i=b[x];if(i&&i.user===a.user)a.relatedActivities.push(i);else{T.push(a),k=x-1;break}}}else T.push(a);k++}return T});function ne(o){return o==="activity"?Q.value:Q.value.filter(e=>e.type===o)}const E=h(!1);function F(o,e){E.value=!1,e!==s.data[o]&&(ie(o,e),N({url:"frappe.client.set_value",params:{doctype:"HD Ticket",name:j.ticketId,fieldname:o,value:e},debounce:500,auto:!0,onSuccess:()=>{I.value=!1,E.value=!1,s.reload()},onError:f=>{if(E.value)return;E.value=!0;const b=f.exc_type?(f.messages||f.message||[]).join(", "):f.message;D.error(b),s.reload()}}))}function ie(o,e){s.data[o]=e,D.success("Ticket updated")}return _e(()=>{Z.on("helpdesk:ticket-update",o=>{o===Number(j.ticketId)&&s.reload()})}),be(()=>{document.title="Helpdesk",Z.off("helpdesk:ticket-update")}),(o,e)=>{var k,a,x;const f=ce,b=B("FeatherIcon"),T=B("Button");return d(),R("div",ot,[t(s).data?(d(),g(t(Le),{key:0},{"left-header":v(()=>[r(t(Ve),{items:L.value,class:"breadcrumbs"},{prefix:v(({item:i})=>[i.icon?(d(),g(t(Xe),{key:0,icon:i.icon,class:"mr-1 h-4 flex items-center justify-center self-center"},null,8,["icon"])):V("",!0)]),_:1},8,["items"])]),"right-header":v(()=>{var i;return[t(s).data._customActions?(d(),g(f,{key:0,actions:t(s).data._customActions},null,8,["actions"])):V("",!0),(i=t(s).data.assignees)!=null&&i.length?(d(),R("div",nt,[(d(),g(K(t(s).data.assignees.length==1?"Button":"div"),null,{default:v(()=>[r(t(Oe),{avatars:t(s).data.assignees,onClick:e[0]||(e[0]=S=>U.value=!0)},null,8,["avatars"])]),_:1}))])):(d(),R("button",{key:2,class:"rounded bg-gray-100 px-2 py-1.5 text-base text-gray-800",onClick:e[1]||(e[1]=S=>U.value=!0)}," Assign ")),r(t(Ae),{options:se.value},{default:v(({open:S})=>[r(T,{label:t(s).data.status},{prefix:v(()=>[r(t(G),{class:$e(t(_).textColorMap[t(s).data.status])},null,8,["class"])]),suffix:v(()=>[r(b,{name:S?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label"])]),_:1},8,["options"])]}),_:1})):V("",!0),t(s).data?(d(),R("div",it,[$("div",lt,[$("div",rt,[r(t(De),{modelValue:J.value,"onUpdate:modelValue":e[4]||(e[4]=i=>J.value=i),tabs:oe},{default:v(()=>[r(t(Ue)),r(t(Re),{class:"h-full"},{default:v(({tab:i})=>{var S;return[r(t(Be),{ref_key:"ticketAgentActivitiesRef",ref:m,activities:ne(i.name),title:i.label,"ticket-status":(S=t(s).data)==null?void 0:S.status,onUpdate:e[2]||(e[2]=()=>{t(s).reload()}),"onEmail:reply":e[3]||(e[3]=le=>{l.value.replyToEmail(le)})},null,8,["activities","title","ticket-status"])]}),_:1})]),_:1},8,["modelValue"])]),(d(),g(t(Ee),{ref_key:"communicationAreaRef",ref:l,modelValue:t(s).data,"onUpdate:modelValue":e[5]||(e[5]=i=>t(s).data=i),"to-emails":[(k=t(s).data)==null?void 0:k.raised_by],"cc-emails":[],"bcc-emails":[],key:(a=t(s).data)==null?void 0:a.name,onUpdate:e[6]||(e[6]=()=>{t(s).reload(),m.value.scrollToLatestActivity()})},null,8,["modelValue","to-emails"]))]),r(t(st),{ticket:t(s).data,onUpdate:e[7]||(e[7]=({field:i,value:S})=>F(i,S)),"onEmail:open":e[8]||(e[8]=i=>l.value.toggleEmailBox()),onReload:e[9]||(e[9]=i=>t(s).reload())},null,8,["ticket"])])):V("",!0),t(s).data&&t(U)?(d(),g(t(Fe),{key:2,modelValue:t(U),"onUpdate:modelValue":e[10]||(e[10]=i=>xe(U)?U.value=i:null),assignees:t(s).data.assignees,docname:p.ticketId,team:(x=t(s).data)==null?void 0:x.agent_group,doctype:"HD Ticket",onUpdate:e[11]||(e[11]=()=>{t(s).reload()})},null,8,["modelValue","assignees","docname","team"])):V("",!0),r(t(te),{modelValue:n.value,"onUpdate:modelValue":e[13]||(e[13]=i=>n.value=i),options:{title:"Rename Subject"}},{"body-content":v(()=>[$("div",ct,[r(t(Te),{modelValue:c.value,"onUpdate:modelValue":e[12]||(e[12]=i=>c.value=i),type:"textarea",size:"sm",variant:"subtle",disabled:!1},null,8,["modelValue"]),r(T,{variant:"solid",loading:I.value,label:"Rename",onClick:M},null,8,["loading"])])]),_:1},8,["modelValue"])])}}});export{Ut as default};
//# sourceMappingURL=TicketAgent-40882a3e.js.map
