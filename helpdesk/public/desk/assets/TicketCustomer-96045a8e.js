import{s as Z,_ as J}from"./formCustomisation-2c9d6b04.js";import{d as O,ae as ee,c as $,aM as A,k as _,l as i,g as u,h as t,w as k,y as b,F as H,G as M,f as T,r as U,e as c,t as C,L as z,x as V,W as j,u as te,A as S,b as ae,aK as se,M as oe,a5 as K,X as ne,ay as L,z as N,Q as D,Y as le,Z as ie,aP as P,au as re,aq as ce}from"./index-62a62e6e.js";import{_ as de}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-c8f73628.js";import{I as ue}from"./more-horizontal-44c34a82.js";import{d as r}from"./dayjs-23c9994e.js";import{L as me}from"./knowledgeBase-e21cae7f.js";import{g as pe}from"./globalStore-353b4b5d.js";import{a as fe,_ as _e}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-f4b785e0.js";import{I as q}from"./symbols-7dbf6ecf.js";import{_ as be}from"./Avatar.vue_vue_type_script_setup_true_lang-d4d1e36b.js";import{_ as ke}from"./TicketCustomerTemplateFields.vue_vue_type_script_setup_true_lang-bf122d86.js";import{_ as xe}from"./TicketConversation.vue_vue_type_script_setup_true_lang-d766f73b.js";import{_ as ve}from"./TicketFeedback.vue_vue_type_script_setup_true_lang-6b4b7cf4.js";import{_ as ge}from"./TicketTextEditor.vue_vue_type_script_setup_true_lang-7ec8927e.js";import"./Dropdown.vue_vue_type_script_setup_true_lang-8f31c9b1.js";import"./StarRating.vue_vue_type_script_setup_true_lang-af2bc1e1.js";import"./TicketCommunication.vue_vue_type_script_setup_true_lang-f7a4d608.js";import"./EmailContent-07157247.js";import"./AttachmentItem.vue_vue_type_script_setup_true_lang-cb2930a7.js";import"./UserAvatar.vue_vue_type_script_setup_true_lang-3c21d3f7.js";import"./index-81b6d358.js";import"./FileUploader-08f99e92.js";import"./TextEditor.vue_vue_type_script_setup_true_lang-3540b034.js";const ye={class:"flex w-[382px] flex-col border-l gap-4"},he={class:"flex flex-col gap-4 pt-0 px-5 py-3 border-b"},we={class:"flex gap-2"},Ce={class:"flex items-center justify-between"},Te={class:"w-[242px] truncate text-2xl font-medium"},$e={key:0,class:"flex gap-1.5"},Ie={class:"flex items-center text-base leading-5"},Fe={class:"w-[126px] text-sm text-gray-600"},Se={class:"w-[126px] text-gray-600 text-sm"},De={class:"break-words text-base text-gray-800"},Be={class:"flex flex-col gap-4 pt-0 px-5 py-3"},Ae={class:"flex items-center text-base leading-5"},je={class:"w-[126px] text-sm text-gray-600"},Ee=O({__name:"TicketCustomerSidebar",emits:["open"],setup(I,{emit:y}){const m=y,e=ee(q),x=$(()=>{const s=v(),d=p();return[{title:"First Response",value:e.data.first_responded_on||e.data.response_by,label:s.label,theme:s.color},{title:"Resolution",value:e.data.resolution_date||e.data.resolution_by,label:d.label,theme:d.color}]});function v(){let s=null;return!e.data.first_responded_on&&r().isBefore(r(e.data.response_by))?s={label:`Due in ${A(r(e.data.response_by).diff(r(),"s"))}`,color:"orange"}:r(e.data.first_responded_on).isBefore(r(e.data.response_by))?s={label:`Fulfilled in ${A(r(e.data.first_responded_on).diff(r(e.data.creation),"s"))}`,color:"green"}:s={label:"Failed",color:"red"},s}function p(){let s=null;return!e.data.resolution_date&&r().isBefore(e.data.resolution_by)?s={label:`Due in ${A(r(e.data.resolution_by).diff(r(),"s"))}`,color:"orange"}:r(e.data.resolution_date).isBefore(e.data.resolution_by)?s={label:`Fulfilled in ${A(r(e.data.resolution_date).diff(r(e.data.creation),"s"))}`,color:"green"}:s={label:"Failed",color:"red"},s}const h=$(()=>[{label:"Ticket ID",value:e.data.name},{label:"Status",value:B(e.data.status),bold:!0}]),g=$(()=>{const s=[{label:"Subject",value:e.data.subject},{label:"Team",value:e.data.agent_group||"-"},{label:"Priority",value:e.data.priority}],d=e.data.template.fields.filter(f=>!f.hide_from_customer&&["subject","team","priority"].indexOf(f.fieldname)===-1).map(f=>({label:f.label,value:e.data[f.fieldname]}));return[...s,...d]});function B(s){switch(s){case"Replied":return"Awaiting reply";default:return s}}return(s,d)=>{const f=_e,F=U("Button"),E=U("Badge"),R=fe;return c(),_("div",ye,[d[1]||(d[1]=i("div",{class:"flex items-center justify-between border-b px-5 py-3"},[i("span",{class:"cursor-copy text-lg font-semibold"},"Ticket details")],-1)),i("div",he,[i("div",we,[u(t(be),{size:"2xl",image:t(e).data.contact.image,label:t(e).data.contact.name},null,8,["image","label"]),i("div",Ce,[u(t(z),{text:t(e).data.contact.name},{default:k(()=>[i("div",Te,C(t(e).data.contact.name),1)]),_:1},8,["text"]),t(e).data.feedback_rating?b("",!0):(c(),_("div",$e,[u(t(z),{text:t(e).data.contact.email_id},{default:k(()=>[u(F,{class:"h-7 w-7",onClick:d[0]||(d[0]=n=>m("open"))},{icon:k(()=>[u(f,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])]))])]),(c(!0),_(H,null,M(h.value,n=>(c(),_("div",Ie,[i("span",Fe,C(n.label),1),i("span",{class:V(["text-base text-gray-800 flex-1",!n.value&&"text-ink-gray-4"])},C(n.value||"—"),3)]))),256)),(c(!0),_(H,null,M(x.value,n=>(c(),_("div",{key:n.label,class:"flex items-center text-base"},[i("div",Se,C(n.title),1),i("div",De,[u(t(z),{text:t(r)(n.value).long()},{default:k(()=>[u(E,{label:n.label,theme:n.theme,variant:"outline"},null,8,["label","theme"])]),_:2},1032,["text"])])]))),128))]),t(e).data.feedback_rating?(c(),T(R,{key:0,class:"border-b text-base text-gray-600",ticket:t(e).data},null,8,["ticket"])):b("",!0),i("div",Be,[(c(!0),_(H,null,M(g.value,n=>(c(),_("div",Ae,[i("span",je,C(n.label),1),i("span",{class:V(["text-base text-gray-800 flex-1",!n.value&&"text-ink-gray-4"])},C(n.value||"—"),3)]))),256))])])}}});function Re(I,y=!1,m,e,x){return j({url:"helpdesk.helpdesk.doctype.hd_ticket.api.get_one",cache:["Ticket",I],params:{name:I,is_customer_portal:y},auto:!0,transform:p=>{m&&m(p)},onSuccess:p=>{e&&e(p)},onError:p=>{console.log("here"),x&&x(p)}})}const He={key:0,class:"flex flex-col"},Me={class:"flex overflow-hidden h-full w-full"},ze={class:"flex flex-col flex-1 w-full md:max-w-[calc(100%-382px)]"},Ue=["onKeydownCapture"],ct=O({__name:"TicketCustomer",props:{ticketId:{}},setup(I){const y=te(),m=I,e=Re(m.ticketId,!0,null,o=>{Z(e,{doc:o,call:le,router:y,toast:D,$dialog:s,updateField:f,createToast:D.create})},()=>{D.error("Ticket not found"),y.replace("/my-tickets")});ie(q,e);const x=S(null),v=S(""),p=S([]),h=S(!1),g=S(!1),{isMobileView:B}=ae(),{$dialog:s}=pe(),d=j({url:"run_doc_method",debounce:300,makeParams:()=>({dt:"HD Ticket",dn:m.ticketId,method:"create_communication_via_contact",args:{message:v.value,attachments:p.value}}),onSuccess:()=>{x.value.editor.commands.clearContent(!0),p.value=[],g.value=!1,e.reload()}});function f(o,a,w=()=>{}){E(o,a),w()}function F(){ce(v.value)||d.loading||d.submit()}function E(o,a){j({url:"frappe.client.set_value",params:{doctype:"HD Ticket",name:m.ticketId,fieldname:o,value:a},auto:!0,onSuccess:()=>{e.reload(),D.success("Ticket updated")}})}function R(){Y.value?h.value=!0:n()}function n(){s({title:"Close Ticket",message:"Are you sure you want to close this ticket?",actions:[{label:"Confirm",variant:"solid",onClick(o){e.data.status="Closed",G.submit({fieldname:"status",value:"Closed"},{onSuccess:()=>{D.success("Ticket closed")}}),o()}}]})}const G=j({url:"frappe.client.set_value",debounce:300,makeParams:o=>({doctype:"HD Ticket",name:m.ticketId,fieldname:o.fieldname,value:o.value}),onSuccess:()=>{h.value=!1,e.reload()}}),Q=$(()=>{var a;let o=[{label:"Tickets",route:{name:"TicketsCustomer"}}];return o.push({label:(a=e.data)==null?void 0:a.subject,route:{name:"TicketCustomer"}}),o}),W=$(()=>e.data.status!=="Closed"),{isFeedbackMandatory:X}=se(),Y=$(()=>{var a,w;return((w=(a=e.data)==null?void 0:a.communications)==null?void 0:w.some(l=>l.sender!==e.data.raised_by))&&X});return oe(()=>{document.title=m.ticketId,K.on("helpdesk:ticket-update",o=>{o===Number(m.ticketId)&&e.reload()})}),ne(()=>{document.title="Helpdesk",K.off("helpdesk:ticket-update")}),(o,a)=>{const w=J;return t(e).data?(c(),_("div",He,[u(t(me),null,{"left-header":k(()=>[u(t(de),{items:Q.value},null,8,["items"])]),"right-header":k(()=>[t(e).data._customActions?(c(),T(w,{key:0,actions:t(e).data._customActions},null,8,["actions"])):b("",!0),t(e).data.status!=="Closed"?(c(),T(t(P),{key:1,label:"Close",theme:"gray",variant:"solid",onClick:a[0]||(a[0]=l=>R())},{prefix:k(()=>[u(t(ue),{icon:"lucide:check"})]),_:1})):b("",!0)]),_:1}),i("div",Me,[i("section",ze,[t(B)?(c(),T(ke,{key:0})):b("",!0),u(xe,{class:"grow"}),i("div",{class:"w-full p-5",onKeydownCapture:[L(N(F,["ctrl","stop"]),["enter"]),L(N(F,["meta","stop"]),["enter"])]},[W.value?(c(),T(ge,{key:0,ref_key:"editor",ref:x,attachments:p.value,"onUpdate:attachments":a[1]||(a[1]=l=>p.value=l),content:v.value,"onUpdate:content":a[2]||(a[2]=l=>v.value=l),expand:g.value,"onUpdate:expand":a[3]||(a[3]=l=>g.value=l),placeholder:"Type a message",autofocus:"",onClear:a[4]||(a[4]=()=>g.value=!1),uploadFunction:l=>t(re)(l,"HD Ticket",m.ticketId)},{"bottom-right":k(()=>{var l;return[u(t(P),{label:"Send",theme:"gray",variant:"solid",disabled:((l=o.$refs.editor)==null?void 0:l.editor.isEmpty)||t(d).loading,loading:t(d).loading,onClick:F},null,8,["disabled","loading"])]}),_:1},8,["attachments","content","expand","uploadFunction"])):b("",!0)],40,Ue)]),t(B)?b("",!0):(c(),T(Ee,{key:0,onOpen:a[5]||(a[5]=l=>g.value=!0)}))]),u(ve,{open:h.value,"onUpdate:open":a[6]||(a[6]=l=>h.value=l)},null,8,["open"])])):b("",!0)}}});export{ct as default};
//# sourceMappingURL=TicketCustomer-96045a8e.js.map
